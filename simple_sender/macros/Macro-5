No Touch Plate
Use when XYZ work zero is set manually; captures TOOL_REFERENCE at the fixed sensor for Tool Change.
#dbe8eb
#00006c
; Use this when you've already set X/Y/Z zero manually and only need tool-reference capture.
%macro.state.SAFE_HEIGHT = -5
%macro.state.PROBE_X_LOCATION = -1.5
%macro.state.PROBE_Y_LOCATION = -1224
%macro.state.PROBE_Z_LOCATION = float(app.settings.get("macro_probe_z_location", -5.0))
%macro.state.PROBE_SAFETY_MARGIN = max(0.0, float(app.settings.get("macro_probe_safety_margin", 3.0)))
%macro.state.Z_MAX_TRAVEL = 150.0
%macro.state.grbl_settings = getattr(getattr(app, "settings_controller", None), "_settings_data", {}) or {}
%if "$132" in macro.state.grbl_settings: macro.state.Z_MAX_TRAVEL = float(macro.state.grbl_settings["$132"][0])
%macro.state.PROBE_DISTANCE = max(1.0, round(macro.state.Z_MAX_TRAVEL + macro.state.PROBE_Z_LOCATION - macro.state.PROBE_SAFETY_MARGIN, 3))
%macro.state.PROBE_RAPID_FEEDRATE = 200

%wait
%WCS = WCS
%PLANE = plane
%UNITS = units
%DISTANCE = distance
%FEEDMODE = feedmode
%SPINDLE = spindle
%COOLANT = coolant
%msg (No-touch-plate start: units=[units] WCS=[WCS] wx=[wx] wy=[wy] wz=[wz] mx=[mx] my=[my] mz=[mz])

%macro.prompt_tool_ref = getattr(macro.state, "TOOL_REFERENCE", None)
%if isinstance(macro.prompt_tool_ref, float): macro.prompt_tool_ref = round(macro.prompt_tool_ref, 4)
["PROMPT resumelabel=Proceed This will overwrite the stored tool reference. Continue?" if macro.prompt_tool_ref is not None else ""][""]
M0 (Confirm XYZ work zero is already set manually. Ensure touch plate is removed and clip is on the tool.)

G21
M5
G90
G53 G0 Z[macro.state.SAFE_HEIGHT]
G53 G0 X[macro.state.PROBE_X_LOCATION] Y[macro.state.PROBE_Y_LOCATION]
%wait
G53 Z[macro.state.PROBE_Z_LOCATION]

G91
G38.2 Z-[macro.state.PROBE_DISTANCE] F[macro.state.PROBE_RAPID_FEEDRATE]
G0 Z2
G4 P0.25
G38.2 Z-5 F40
G4 P0.25
G38.4 Z10 F20
G4 P0.25
G38.2 Z-2 F5
G4 P0.25
G38.4 Z10 F5
G90
%wait
%update
%macro.state.TOOL_REFERENCE = wz
%msg (Reference tool height stored: [macro.state.TOOL_REFERENCE] wz=[wz])
G91
G0 Z5
G90
G53 Z[macro.state.SAFE_HEIGHT]
%wait
G0 X0 Y0
STATE_RETURN
