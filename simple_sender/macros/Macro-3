Attempt Reference Tool Recovery
Re-measures the installed reference tool at the sensor and restores TOOL_REFERENCE when it is missing.

; Use the same probe offsets/feeds so recovery places the sensor back where it belongs; adjust PROBE_DISTANCE if your switch is deeper.
%macro.state.SAFE_HEIGHT = -5
%macro.state.PROBE_X_LOCATION = -1.5
%macro.state.PROBE_Y_LOCATION = -1224
%macro.state.PROBE_Z_LOCATION = -5
%macro.state.PROBE_DISTANCE = 100
%macro.state.PROBE_RAPID_FEEDRATE = 200

%if getattr(macro.state, "TOOL_REFERENCE", None) is not None: raise RuntimeError("TOOL_REFERENCE already exists; clear macro.state.TOOL_REFERENCE before running this macro.")

%wait
M0 (Install the original reference tool and continue when ready.)
G21
M5
G90
G53 G0 Z[macro.state.SAFE_HEIGHT]
G53 G0 X[macro.state.PROBE_X_LOCATION] Y[macro.state.PROBE_Y_LOCATION]
%wait
G53 G0 Z[macro.state.PROBE_Z_LOCATION]
%wait

G91
G38.2 Z-[macro.state.PROBE_DISTANCE] F[macro.state.PROBE_RAPID_FEEDRATE]
G0 Z2
G38.2 Z-5 F40
G4 P0.25
G38.4 Z10 F20
G4 P0.25
G38.2 Z-2 F10
G4 P0.25
G38.4 Z10 F5
G4 P0.25
G90
%wait
%macro.state.TOOL_REFERENCE = mz
%msg (Recovered TOOL_REFERENCE = [macro.state.TOOL_REFERENCE])
G91
G0 Z5
G90
G53 G0 Z[macro.state.SAFE_HEIGHT]
%wait
M0 (Reference tool recovery complete; the machine is parked at the sensor.)
